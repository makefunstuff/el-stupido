# el-stupido project manifest
# composable primitives compiler — tiny LLMs emit JSON, compiler wires building blocks

[project]
name = el-stupido
desc = composable primitives compiler: LLMs pick+wire reusable blocks, compiler generates glue
bin = esc
lang = Rust
build = cd compiler && cargo build
run = ./compiler/target/debug/esc <subcommand>

[architecture]
pipeline = JSON graph manifest -> validate (types + binds + effect capabilities) -> emit Rust -> rustc -> native binary
thesis = machine-first compiled IR for constrained LLM output, not a human language and not a domain framework
primitives = core compute/io/fs building blocks with typed params, typed binds, capabilities, and effects
library = grows over time; domain packs can be layered outside core compiler
formats = tape (canonical compact), .esc (line-based), JSON (compat)
agent = LLM forges native tools on demand via --machine --store, caches in ~/.esc/, reuses by hash

[subcommands]
compose = JSON manifest -> validate -> emit Rust -> compile -> binary (--machine for JSON output, --store for cache)
expand = JSON manifest -> print generated Rust source
grammar = print GBNF grammar for constrained LLM output
primitives = list all available primitives with params/binds/provides/requires/effects (--machine for JSON)
tools = manage tool cache (list, info, forget, clear)
inspect = read binary metadata trailer (manifest + IO contract + hash)
memory = query/manage tool+note memory graph (search, show, record, relate, log, note, notes, resolve, setup)

[primitives]
const_num = numeric constant (value:f64) -> provides:num effects:pure
const_str = string constant (value:str) -> provides:str effects:pure
add/sub/mul/div = arithmetic (bind lhs:num, rhs:num) -> provides:num effects:pure
gt/eq_num = comparisons (bind lhs:num, rhs:num) -> provides:bool effects:pure
and_bool/or_bool/not_bool = boolean logic (bind bool inputs) -> provides:bool effects:pure
select_num/select_str = branchless select (bind cond:bool + typed branches) -> provides:num|str effects:pure
repeat_str = bounded string repetition (bind text:str, times:num) -> provides:str effects:pure
to_string = numeric formatting (bind value:num) -> provides:str effects:pure
concat = string concatenation (bind left:str, right:str) -> provides:str effects:pure
len_str = string length (bind text:str) -> provides:num effects:pure
cwd = current working directory -> provides:str effects:pure
path_join = path concatenation (bind left:str, right:str) -> provides:str effects:pure
read_stdin = stdin line read (prompt?:str) -> provides:str effects:io_read,io_write
parse_num = string to f64 (bind text:str) -> provides:num effects:pure
read_file = file read (path:str) -> provides:str effects:fs_read
read_file_dyn = file read (bind path:str) -> provides:str effects:fs_read
write_file = file write (path:str, bind content:str) -> provides:sink effects:fs_write
write_file_dyn = file write (bind path:str, bind content:str) -> provides:sink effects:fs_write
print_num = stdout print number (bind value:num) -> provides:sink effects:io_write
print_str = stdout print string (bind value:str) -> provides:sink effects:io_write
arg_num = CLI argument as number (index:f64) -> provides:num effects:pure
arg_str = CLI argument as string (index:f64) -> provides:str effects:pure
env_str = environment variable (name:str) -> provides:str effects:env_read
env_str_dyn = environment variable (bind name:str) -> provides:str effects:env_read
arg_count = CLI argument count -> provides:num effects:pure
format_str = template with {1}/{2} (template:str, bind v1:str, bind v2?:str) -> provides:str effects:pure
exit_code = exit with code (bind code:num) -> provides:sink effects:pure
substr = extract substring (bind text:str, start:num, len:num) -> provides:str effects:pure
upper_str = uppercase (bind text:str) -> provides:str effects:pure
lower_str = lowercase (bind text:str) -> provides:str effects:pure
trim_str = trim whitespace (bind text:str) -> provides:str effects:pure
contains_str = substring check (bind text:str, needle:str) -> provides:bool effects:pure
replace_str = replace all (bind text:str, pattern:str, replacement:str) -> provides:str effects:pure
split_count = count fields (bind text:str, delim:str) -> provides:num effects:pure
split_nth = get nth field (bind text:str, delim:str, index:num) -> provides:str effects:pure
mod_num = modulo (bind lhs:num, rhs:num) -> provides:num effects:pure
floor = floor (bind value:num) -> provides:num effects:pure
abs = absolute value (bind value:num) -> provides:num effects:pure
lt = less-than (bind lhs:num, rhs:num) -> provides:bool effects:pure
read_stdin_all = read all stdin -> provides:str effects:io_read
append_file = append to file (path:str, bind content:str) -> provides:sink effects:fs_write
http_get = HTTP GET static URL (url:str) -> provides:str effects:net_read
http_get_dyn = HTTP GET dynamic URL (bind url:str) -> provides:str effects:net_read

[source]
main = compiler/src/main.rs (CLI entry point, 7 subcommands)
primitive = compiler/src/primitive.rs (Primitive/ParamDef/BindDef/effects, Registry with builtins)
compose = compiler/src/compose.rs (graph manifest parsing + typed validation + capability safety + canonical tape + IO contract)
emit = compiler/src/emit.rs (Rust code emitter from validated graph, core primitives only)
grammar = compiler/src/grammar.rs (GBNF grammar auto-generation from registry)
cache = compiler/src/cache.rs (tool cache: SHA-256 hash, registry, binary trailer read/write)
memory = compiler/src/memory.rs (persistent tool memory graph: entries + edges + search + record, atomic-server backend)
atomic = compiler/src/atomic.rs (Ed25519 signed commits, curl HTTP client, schema bootstrap, atomic-server integration)
agent = agent/esc_agent.py (autonomous agent loop POC: goal -> compile -> cache -> invoke)
embed_exp = agent/embedding_experiment.py (structural vs embedding similarity experiment)
forge_agent = .opencode/agents/forge.md (opencode subagent for tool forging via @forge)
global_agent = ~/.config/opencode/opencode.json (global prompt: every session knows about esc + memory)

[examples]
sum = examples/compose_sum.json (pure arithmetic + stdout)
sum_esc = examples/compose_sum.esc (same sum program in compact line-based .esc form)
sum_tape = examples/compose_sum.tape (opcode tape form with positional args)
prompt_double = examples/compose_prompt_double.json (stdin + parse + arithmetic + stdout)
prompt_double_esc = examples/compose_prompt_double.esc (quoted strings + bindings in .esc form)
prompt_double_tape = examples/compose_prompt_double.tape (compact tape form)
file_report = examples/compose_file_report.json (file read + string length + stdout)
branch_repeat = examples/compose_branch_repeat.json (boolean logic + select + bounded repeat)
dynamic_path = examples/compose_dynamic_path.json (cwd + path_join + dynamic file read)
add_args = examples/compose_add_args.json (CLI args + arithmetic — reusable parameterized tool)
weather = examples/compose_weather.json (HTTP GET + string ops — dynamic URL from CLI arg)
http_test = examples/compose_http_test.json (static HTTP GET — fetch URL and print body)
http_dyn = examples/compose_http_dyn.json (dynamic HTTP GET — URL from CLI arg)

[tape_opcodes]
gn = arg_num (get arg as number)
gs = arg_str (get arg as string)
ev = env_str (read env var by name)
ed = env_str_dyn (read env var by bound name)
gc = arg_count (count CLI args)
fm = format_str (template + v1 + v2?)
ex = exit_code (exit with bound code)
su = substr (text + start + len)
up = upper_str (uppercase)
lo = lower_str (lowercase)
tr = trim_str (trim whitespace)
ct = contains_str (text + needle)
re = replace_str (text + pattern + replacement)
sc = split_count (text + delim)
sn2 = split_nth (text + delim + index)
mo = mod_num (lhs + rhs)
fl = floor (value)
ab = abs (value)
lt = lt (lhs + rhs)
ra = read_stdin_all (read all stdin)
af = append_file (path + content)
hg = http_get (url as string param)
hd = http_get_dyn (url as bind ref)

[memory]
backend = atomic-server at 192.168.1.128:9884 (primary), ~/.esc/memory.json (flat-file fallback)
auth = Ed25519 signed commits via ESC_ATOMIC_URL + ESC_ATOMIC_KEY env vars (~/.config/environment.d/esc.conf)
reads = prefer atomic-server, fall back to flat-file on error
writes = dual-write to both atomic-server and flat-file
schema = 16 properties at /esc/prop/*, 2 classes at /esc/class/*, tools at /esc/tool/<hash>, edges at /esc/edge/*
search = esc memory search "<query>" (graph-aware: keyword match + edge walk + tag expansion, compact output)
show = esc memory show <hash> (full details of a tool or note by hash prefix)
note = esc memory note --kind <kind> --context "<ctx>" --tags "<tags>" "<summary>" "<detail>"
notes = esc memory notes [--kind discovery] [--context homelab] (list/filter notes)
resolve = esc memory resolve <hash> [--status resolved] (mark note resolved/superseded)
record = esc memory record <hash> --goal "..." --tags "..." (update existing tool entry metadata)
auto_record = esc compose --store --goal "..." --tags "..." (records automatically on successful forge)
relate = esc memory relate <from> <to> <rel> (add edge: variant_of, pipes_to, supersedes)
log = esc memory log (unified timeline: tools + notes, newest first — use for "what did we do recently")
setup = esc memory setup (bootstrap atomic-server schema — includes tool + note schemas)
note_kinds = discovery (technical finding), decision (design choice + rationale), pattern (trigger + fix), issue (open problem)
note_statuses = active, resolved, superseded

[notes]
readme = DO NOT MODIFY README.md (human-written)
old_code = all old C source/libs/tools/specs deleted, project is Rust-only now
suckless = SUCKLESS.md defines small-surface design rules and hard limits
tape = TAPE.md documents canonical compact opcode format
